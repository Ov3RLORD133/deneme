/*
    YARA Rules for KeyChaser Malware Sinkhole
    
    This ruleset identifies common malware families and threat patterns
    in C2 payloads captured by the sinkhole infrastructure.
*/

import "pe"

rule win_agent_tesla : infostealer
{
    meta:
        description = "Detects AgentTesla infostealer payloads"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "high"
        reference = "https://malpedia.caad.fkie.fraunhofer.de/details/win.agent_tesla"
        
    strings:
        // Common AgentTesla HTML exfiltration markers
        $html_1 = "<html>" nocase
        $html_2 = "Password:" nocase
        $html_3 = "Username:" nocase
        
        // SMTP exfiltration patterns
        $smtp_1 = "EHLO" nocase
        $smtp_2 = "MAIL FROM:" nocase
        $smtp_3 = "DATA" nocase
        
        // AgentTesla specific strings
        $ag_1 = "Agent Tesla" nocase
        $ag_2 = "AgentTesla" nocase
        
        // System info collection markers
        $sys_1 = "Computer Name:" nocase
        $sys_2 = "IP Address:" nocase
        $sys_3 = "Clipboard Data:" nocase
        
    condition:
        // HTML-based credential theft
        (all of ($html_*) and 2 of ($sys_*)) or
        
        // SMTP exfiltration with credentials
        (2 of ($smtp_*) and any of ($html_*)) or
        
        // Direct AgentTesla identification
        any of ($ag_*)
}

rule generic_credential_stealer : infostealer
{
    meta:
        description = "Detects generic credential theft payloads"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "medium"
        
    strings:
        $cred_1 = "password" nocase
        $cred_2 = "username" nocase
        $cred_3 = "login" nocase
        
        $browser_1 = "chrome" nocase
        $browser_2 = "firefox" nocase
        $browser_3 = "edge" nocase
        
        $email_1 = "smtp" nocase
        $email_2 = "pop3" nocase
        $email_3 = "imap" nocase
        
    condition:
        // Credential keywords + browser or email indicators
        (2 of ($cred_*) and (any of ($browser_*) or any of ($email_*)))
}

rule keylogger_payload : keylogger
{
    meta:
        description = "Detects keystroke logging payloads"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "high"
        
    strings:
        $key_1 = "[ENTER]" nocase
        $key_2 = "[TAB]" nocase
        $key_3 = "[BACKSPACE]" nocase
        $key_4 = "[SHIFT]" nocase
        $key_5 = "[CTRL]" nocase
        
        $time_1 = /\d{2}:\d{2}:\d{2}/  // Timestamp pattern
        $time_2 = /\d{4}-\d{2}-\d{2}/  // Date pattern
        
    condition:
        // Multiple keystroke markers with timestamps
        (3 of ($key_*) and any of ($time_*))
}

rule base64_encoded_payload : encoded
{
    meta:
        description = "Detects Base64-encoded suspicious payloads"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "low"
        
    strings:
        // Base64 padding and common patterns
        $b64_1 = /[A-Za-z0-9+\/]{50,}={1,2}/
        
        // Common Base64-encoded strings
        $sus_1 = "cGFzc3dvcmQ" nocase  // "password"
        $sus_2 = "dXNlcm5hbWU" nocase  // "username"
        $sus_3 = "bWFsd2FyZQ" nocase    // "malware"
        
    condition:
        $b64_1 and any of ($sus_*)
}

rule ransomware_note : ransomware
{
    meta:
        description = "Detects ransomware ransom notes"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "critical"
        
    strings:
        $ran_1 = "ransom" nocase
        $ran_2 = "bitcoin" nocase
        $ran_3 = "decrypt" nocase
        $ran_4 = "payment" nocase
        $ran_5 = "encrypted" nocase
        
        $threat_1 = "files have been encrypted" nocase
        $threat_2 = "pay the ransom" nocase
        $threat_3 = "within" nocase wide ascii
        
    condition:
        (3 of ($ran_*)) or any of ($threat_*)
}

rule pe_suspicious_imports : trojan
{
    meta:
        description = "Detects PE files with suspicious API imports"
        author = "KeyChaser Security Team"
        date = "2026-01-20"
        severity = "medium"
        
    condition:
        pe.is_pe and
        (
            pe.imports("kernel32.dll", "VirtualAlloc") and
            pe.imports("kernel32.dll", "WriteProcessMemory")
        ) or
        (
            pe.imports("wininet.dll", "InternetOpenA") and
            pe.imports("wininet.dll", "InternetReadFile")
        )
}
