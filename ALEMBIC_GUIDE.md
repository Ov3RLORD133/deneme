# KeyChaser - Alembic Database Migrations Guide

## Overview

KeyChaser now uses Alembic for database schema migrations, enabling safe schema evolution in production environments.

## Directory Structure

```
KeyChaser/
├── alembic.ini               # Alembic configuration
├── migrations/               # Migration directory
│   ├── env.py               # Migration environment setup
│   ├── script.py.mako       # Migration template
│   ├── versions/            # Migration version files
│   └── README               # Alembic info
```

## Initial Setup (Already Configured)

The Alembic structure has been initialized and configured to:
- Auto-detect KeyChaser models (Bot, Log, Credential, User)
- Use the SQLite database path from settings
- Import all models for autogenerate support

## Creating Your First Migration

### 1. Generate Initial Migration

Create a migration that captures the current database schema:

```powershell
# From project root
.\.venv\Scripts\activate
alembic revision --autogenerate -m "Initial schema"
```

This will:
- Compare your models to the current database
- Generate a migration file in `migrations/versions/`
- Include upgrade() and downgrade() functions

### 2. Review the Migration

Check the generated file in `migrations/versions/`:

```python
# Example: migrations/versions/abc123_initial_schema.py
def upgrade() -> None:
    # Creates tables, indexes, constraints
    op.create_table('bots',
        sa.Column('id', sa.Integer(), nullable=False),
        # ... other columns
    )

def downgrade() -> None:
    # Reverts changes
    op.drop_table('bots')
```

### 3. Apply the Migration

Run the migration to update the database:

```powershell
alembic upgrade head
```

Output:
```
INFO  [alembic.runtime.migration] Running upgrade -> abc123, Initial schema
```

## Common Migration Commands

### Create a New Migration (After Model Changes)

```powershell
# Autogenerate migration from model changes
alembic revision --autogenerate -m "Add yara_tags column to bots"

# Review the generated file
# Then apply it:
alembic upgrade head
```

### View Migration History

```powershell
# Show current version
alembic current

# Show all migrations
alembic history

# Show pending migrations
alembic history --verbose
```

### Rollback Migrations

```powershell
# Rollback one migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade abc123

# Rollback all migrations (WARNING: Drops all tables!)
alembic downgrade base
```

### Upgrade to Specific Version

```powershell
# Upgrade to specific revision
alembic upgrade abc123

# Upgrade to latest
alembic upgrade head
```

## Example: Adding YARA Tags Column

If you want to add a `yara_tags` column to store YARA detection results:

### 1. Update the Model

Edit `app/models/bot.py`:

```python
class Bot(Base):
    # ... existing columns ...
    yara_tags: Mapped[Optional[str]] = mapped_column(String, nullable=True)
```

### 2. Generate Migration

```powershell
alembic revision --autogenerate -m "Add yara_tags to bot model"
```

### 3. Review and Apply

```powershell
# Check the generated migration in migrations/versions/
# Then apply:
alembic upgrade head
```

## Production Best Practices

### 1. Always Review Autogenerated Migrations

Alembic autogenerate is smart but not perfect. Always review:
- Data migrations (moving data between columns)
- Index names and constraints
- Nullable changes that may fail on existing data

### 2. Test Migrations on Copy of Production DB

```powershell
# Backup production database
copy keychaser.db keychaser_backup.db

# Test migration
alembic upgrade head

# If successful, apply to production
```

### 3. Use Offline Mode for Large Databases

Generate SQL scripts instead of applying directly:

```powershell
alembic upgrade head --sql > migration.sql
# Review migration.sql
# Apply manually if needed
```

## Troubleshooting

### "Target database is not up to date"

The database has pending migrations:

```powershell
alembic upgrade head
```

### "Can't locate revision identified by 'abc123'"

Migration file is missing. Restore from git:

```powershell
git checkout migrations/versions/abc123_*.py
```

### "Circular dependency detected"

Usually caused by complex foreign key relationships. Edit the migration manually to break the cycle.

### Reset Everything (Development Only!)

```powershell
# Delete database
Remove-Item keychaser.db

# Delete migration versions
Remove-Item migrations\versions\*.py

# Recreate from scratch
alembic revision --autogenerate -m "Initial schema"
alembic upgrade head
```

## Integration with KeyChaser

Alembic is now integrated into the KeyChaser workflow:

1. **Model Changes**: Edit models in `app/models/`
2. **Generate Migration**: `alembic revision --autogenerate`
3. **Review**: Check `migrations/versions/`
4. **Test**: Apply on dev database
5. **Deploy**: Apply on production with `alembic upgrade head`

## Advanced: Manual Migrations

For complex data transformations, create an empty migration:

```powershell
alembic revision -m "Migrate old credential format"
```

Edit the generated file:

```python
def upgrade() -> None:
    # Custom SQL or Python code
    op.execute("""
        UPDATE credentials 
        SET cred_type = 'browser_password'
        WHERE application LIKE '%Chrome%'
    """)

def downgrade() -> None:
    # Reverse operation
    op.execute("""
        UPDATE credentials 
        SET cred_type = NULL
        WHERE cred_type = 'browser_password'
    """)
```

## Next Steps

1. **Create Initial Migration**: Capture current schema
2. **Add YARA Tags**: Extend Bot model for malware detection
3. **Version Control**: Commit migrations to git
4. **Production Deployment**: Document migration steps for ops team

## Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy 2.0 Migration Guide](https://docs.sqlalchemy.org/en/20/changelog/migration_20.html)
- KeyChaser Models: `app/models/`
